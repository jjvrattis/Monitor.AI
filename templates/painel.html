<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teccob.AI - Painel de Monitoria</title>
    <!-- Inclui a fonte Poppins do Google Fonts para uma tipografia moderna -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Inclui a biblioteca Tailwind CSS via CDN para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Poppins para uma tipografia moderna e limpa */
        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Define o layout principal para preencher a tela e evitar rolagem na página */
        .page-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Estilos da barra lateral para mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
        }

        /* Estilo da área de drag-and-drop com borda tracejada e transições suaves */
        #drop-zone {
            transition: all 0.3s ease-in-out;
            border-style: dashed;
            cursor: pointer;
        }
        
        /* Oculta o input de arquivo padrão, pois usaremos a área de drag-and-drop como interface */
        #file-input {
            display: none;
        }

        /* Estilo para a animação de carregamento (spinner) */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilo para o botão com gradiente de cor */
        .gradient-button {
            background-image: linear-gradient(to right, #4ade80, #34d399, #10b981);
            transition: all 0.3s ease;
        }

        .gradient-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
        }

        /* Classes para truncar o texto da descrição com um fade-out */
        .description-truncated {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        /* Efeito de gradiente para o fade-out do texto truncado */
        .description-truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(to bottom, transparent, rgba(31, 41, 55, 1));
        }

        /* Estilo para a seção de relatórios para permitir rolagem interna */
        #report-section-scroller {
            height: 100%;
            overflow-y: auto;
            padding-right: 1rem; /* Adiciona espaço para a barra de rolagem não ficar colada */
        }
        
        /* Altura fixa para as divs de conteúdo para evitar que a página inteira role */
        .report-content-div {
            max-height: 30vh;
            overflow-y: auto;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="page-container">
        <!-- Sidebar para o histórico de monitorias e perfil do usuário -->
        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 md:w-72 bg-gray-800 p-6 flex flex-col z-50 transform transition-transform duration-300 md:relative md:translate-x-0 md:rounded-r-2xl md:shadow-lg">
            <!-- Ícone de fechar para mobile -->
            <button id="close-sidebar" class="absolute top-4 right-4 md:hidden text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>

            <!-- Nome da Empresa -->
            <div class="flex items-center space-x-3 mb-8">
                 <!-- Logo da Teccob.AI -->
                <img src="{{ url_for('static', filename='teccob_fundo_transparente.png') }}" alt="Logo Teccob.AI" class="w-20 h-20">
                <span class="text-xl font-semibold text-white">Teccob.AI</span>
            </div>

            <!-- Seção de Histórico de Monitorias -->
            <nav class="flex-grow overflow-y-auto">
                <h2 class="text-xs font-bold uppercase text-gray-500 mb-4 tracking-wide">Histórico de Monitorias</h2>
                <ul id="history-list" class="space-y-2">
                    <!-- Novos relatórios serão adicionados aqui via JS -->
                </ul>
            </nav>

            <!-- Perfil do Analista (fixo no rodapé da sidebar) -->
            <div class="mt-auto flex items-center space-x-3 p-4 bg-gray-700 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user text-green-400">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <span class="text-sm font-semibold text-white">João Victor</span>
            </div>
        </aside>

        <!-- Área de conteúdo principal do painel -->
        <main class="flex-1 p-4 sm:p-8 md:p-12 md:ml-0 min-w-0 flex flex-col h-full">
            <!-- Botão para abrir a sidebar em mobile -->
            <button id="open-sidebar" class="mb-4 md:hidden text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>

            <!-- Container Flex para as duas colunas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full overflow-hidden">
                <!-- Coluna da Esquerda: Upload de Áudio -->
                <div class="w-full bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-700 h-fit overflow-y-auto">
                    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-4 text-center">Analisar novo Áudio</h2>
                    <!-- Área de drag-and-drop -->
                    <div id="drop-zone" class="flex flex-col items-center justify-center p-8 border-4 border-gray-600 rounded-xl transition-colors duration-200 hover:bg-gray-700">
                        <svg class="w-16 h-16 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="mt-4 text-sm font-medium text-gray-400">
                            <span class="font-bold text-gray-200">Clique para selecionar</span> ou arraste e solte o arquivo aqui.
                        </p>
                        <p id="file-name" class="mt-2 text-sm text-gray-400 italic"></p>
                    </div>
                    
                    <!-- Input de arquivo oculto -->
                    <input type="file" id="file-input" accept=".mp3, .wav">
                    
                    <!-- Botão de ação e indicador de carregamento -->
                    <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                        <button id="analyze-button" class="gradient-button w-full sm:w-auto px-8 py-3 rounded-full font-bold text-gray-900 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-500/50">
                            Carregar e Analisar
                        </button>
                        <div id="loading-indicator" class="hidden flex items-center space-x-2 text-green-400">
                            <div class="spinner border-4 border-gray-600 w-6 h-6 rounded-full"></div>
                            <span class="font-semibold">Analisando...</span>
                        </div>
                    </div>
                    <!-- Área de mensagens e resultado -->
                    <div id="message-box" class="p-4 rounded-xl text-center font-medium transition-opacity duration-300 opacity-0 mt-4"></div>
                </div>

                <!-- Coluna da Direita: Relatório de Análise -->
                <div id="report-section" class="space-y-8 flex flex-col h-full overflow-y-auto">
                    <!-- Cabeçalho e botão de compartilhamento -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <header class="mb-4 sm:mb-0">
                            <h1 class="text-3xl sm:text-4xl font-extrabold text-white">Relatório de Análise</h1>
                            <p class="mt-1 text-lg text-gray-400">Relatório de Monitoria de Atendimento</p>
                        </header>

                        <!-- Botão de compartilhamento no WhatsApp -->
                        <button id="share-button" class="flex items-center px-6 py-3 bg-green-500 rounded-full font-bold text-gray-900 shadow-lg hover:bg-green-600 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-more mr-2">
                                <path d="M7.9 20A9.9 9.9 0 0 0 12 22c5.5 0 10-4.5 10-10S17.5 2 12 2 2 6.5 2 12c0 2.2.7 4.3 2 6l-.8 1.6C3.2 20.7 4 22 5.5 22c.4 0 .8-.2 1.2-.4l1.2-.7Z"/>
                                <path d="M8 12h.01"/><path d="M12 12h.01"/><path d="M16 12h.01"/>
                            </svg>
                            <span>Compartilhar</span>
                        </button>
                    </div>
                    
                    <!-- Div com a descrição da análise (expansível) -->
                    <div id="description-panel" class="bg-gray-700 p-6 rounded-xl shadow-inner relative">
                        <h3 class="text-xl font-bold text-white mb-2">Descrição</h3>
                        <div id="description-content" class="text-gray-300 transition-all duration-300 description-truncated">
                            <!-- O conteúdo da descrição será preenchido pelo JavaScript -->
                            <p>Aqui aparecerá a descrição da ligação gerada pela inteligência artificial. Após carregar um arquivo de áudio, você verá um resumo detalhado da conversa neste espaço.</p>
                        </div>
                        <!-- Botão para expandir/recolher a descrição -->
                        <button id="expand-description-btn" class="absolute bottom-4 right-4 text-xs font-semibold text-green-400 hover:text-green-300 transition-colors duration-200">
                            Expandir
                        </button>
                    </div>

                    <!-- Div com o relatório detalhado da Groq -->
                    <div id="groq-report-panel" class="bg-gray-700 p-6 rounded-xl shadow-inner">
                        <h3 class="text-xl font-bold text-white mb-2">Relatório de Monitoria</h3>
                        <div id="groq-report-content" class="bg-gray-900 p-4 rounded-lg whitespace-pre-wrap text-sm text-gray-200">
                            <!-- O conteúdo do relatório será preenchido pelo JavaScript -->
                            <p>O relatório de monitoria completo, gerado pela Groq, será exibido aqui. Ele incluirá a análise de sentimento, principais tópicos, e pontos de atenção da ligação.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Seletores de elementos do DOM
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameSpan = document.getElementById('file-name');
        const analyzeButton = document.getElementById('analyze-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageBox = document.getElementById('message-box');
        const descriptionContent = document.getElementById('description-content');
        const groqReportContent = document.getElementById('groq-report-content');
        const expandDescriptionBtn = document.getElementById('expand-description-btn');
        const shareButton = document.getElementById('share-button');
        const historyList = document.getElementById('history-list');

        let uploadedFile = null;

        // Função para mostrar mensagens temporárias na caixa de mensagens
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.style.opacity = '1';
            
            messageBox.className = 'p-4 rounded-xl text-center font-medium transition-opacity duration-300 opacity-100';
            if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-700', 'text-gray-300');
            }

            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 5000);
        }

        // --- Lógica do drag-and-drop e análise ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('dragover', () => {
            dropZone.classList.add('bg-gray-700', 'border-green-500');
        }, false);
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-gray-700', 'border-green-500');
        }, false);

        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('bg-gray-700', 'border-green-500');
            const files = e.dataTransfer.files;
            handleFile(files[0]);
        }, false);

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            handleFile(files[0]);
        });

        function handleFile(file) {
            if (!file || (!file.type.startsWith('audio/mpeg') && !file.type.startsWith('audio/wav'))) {
                showMessage('Por favor, selecione um arquivo de áudio (.mp3 ou .wav).', 'error');
                uploadedFile = null;
                fileNameSpan.textContent = '';
                return;
            }

            uploadedFile = file;
            fileNameSpan.textContent = `Arquivo selecionado: ${file.name}`;
            showMessage(`Arquivo "${file.name}" pronto para ser analisado.`, 'success');
        }

        // Lógica do botão de análise
        analyzeButton.addEventListener('click', async () => {
            if (!uploadedFile) {
                showMessage('Nenhum arquivo de áudio foi selecionado.', 'error');
                return;
            }

            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            showMessage('Carregando e analisando o arquivo...', 'info');

            // Chamada real para o backend Flask
            const formData = new FormData();
            formData.append('audio_file', uploadedFile);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    updateReportUI(result.relatorio, result.descricao);
                    addReportToHistory(uploadedFile.name, result.relatorio, result.descricao);
                    showMessage('Análise concluída com sucesso!', 'success');
                } else {
                    showMessage(`Erro na análise: ${result.relatorio}`, 'error');
                }
                
            } catch (error) {
                showMessage(`Ocorreu um erro na requisição: ${error.message}`, 'error');
            } finally {
                analyzeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                uploadedFile = null;
                fileNameSpan.textContent = '';
            }
        });

        // --- Lógica para abrir/fechar sidebar e compartilhar no WhatsApp ---
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');

        openSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('active');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('active');
        });

        shareButton.addEventListener('click', () => {
            const reportText = groqReportContent.textContent.trim();
            const encodedText = encodeURIComponent(reportText);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            window.open(whatsappUrl, '_blank');
        });

        // --- Lógica da descrição expansível ---
        let isDescriptionExpanded = false;

        expandDescriptionBtn.addEventListener('click', () => {
            isDescriptionExpanded = !isDescriptionExpanded;
            if (isDescriptionExpanded) {
                descriptionContent.classList.remove('description-truncated');
                expandDescriptionBtn.textContent = 'Recolher';
            } else {
                descriptionContent.classList.add('description-truncated');
                expandDescriptionBtn.textContent = 'Expandir';
            }
        });

        // Função para atualizar a interface com o relatório
        function updateReportUI(report, description) {
            descriptionContent.textContent = description;
            groqReportContent.textContent = report;
            
            // Reinicia o estado de expansão da descrição
            isDescriptionExpanded = false;
            descriptionContent.classList.add('description-truncated');
            expandDescriptionBtn.textContent = 'Expandir';
        }

        // --- Lógica para adicionar relatórios ao histórico ---
        let reportCount = 0;
        const reportsHistory = [];

        function addReportToHistory(fileName, report, description) {
            reportCount++;
            const newReport = { id: reportCount, name: fileName, report: report, description: description };
            reportsHistory.unshift(newReport); // Adiciona no início do array
            
            const newLi = document.createElement('li');
            newLi.className = 'p-3 bg-gray-700 hover:bg-gray-600 rounded-md cursor-pointer transition-colors duration-200';
            newLi.textContent = `Relatório #${reportCount} - ${fileName}`;
            newLi.dataset.reportId = reportCount;
            
            historyList.prepend(newLi); // Adiciona ao topo da lista

            // Limita o histórico a 5 itens
            if (historyList.children.length > 5) {
                historyList.lastElementChild.remove();
            }
        }

        historyList.addEventListener('click', (e) => {
            const listItem = e.target.closest('li');
            if (listItem) {
                const reportId = parseInt(listItem.dataset.reportId);
                const reportData = reportsHistory.find(r => r.id === reportId);
                if (reportData) {
                    updateReportUI(reportData.report, reportData.description);
                }
            }
        });
    </script>
</body>
</html>
